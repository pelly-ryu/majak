<!DOCTYPE html>
<html>
<head>
    <title>Mahjong Soul URL Data Extraction Demo</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        input[type="text"] { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .highlight { 
            background: #fff3cd; 
            padding: 2px 4px; 
            border-radius: 2px;
        }
        
        h1, h2 { color: #333; }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 15px 0;
        }
        .stat-box { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center;
        }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>üÄÑ Mahjong Soul URL Data Extraction Demo</h1>
    
    <div class="container">
        <h2>Test Your URL</h2>
        <input type="text" id="urlInput" placeholder="Enter Mahjong Soul URL..." value="https://mahjongsoul.game.yo-star.com/?paipu=250804-70f742aa-e642-478a-bb72-6d2453cae2fb_a922337773">
        <button onclick="analyzeURL()">üîç Analyze URL</button>
        <button onclick="loadSavedURL()">üìã Load Saved URL</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>
    
    <div class="container">
        <h2>Quick Test URLs</h2>
        <button onclick="testURL('https://mahjongsoul.game.yo-star.com/?paipu=250804-70f742aa-e642-478a-bb72-6d2453cae2fb_a922337773')">üéØ Your Replay URL</button>
        <button onclick="testURL('https://mahjongsoul.game.yo-star.com/game?room=4&mode=2')">üéÆ Game URL</button>
        <button onclick="testURL('https://mahjongsoul.game.yo-star.com/lobby')">üè† Lobby URL</button>
        <button onclick="testURL('https://mahjongsoul.game.yo-star.com/?paipu=241225-12345678-abcd-efgh-ijkl-123456789012_a987654321')">üì∫ Sample Replay</button>
    </div>
    
    <div id="results"></div>

    <script src="../src/game_context.js"></script>
    <script>
        function extractPaipuData(url) {
            if (!url) return null;
            
            try {
                const urlObj = new URL(url);
                const paipu = urlObj.searchParams.get('paipu');
                
                if (paipu) {
                    const parts = paipu.split('_');
                    const gameId = parts[0];
                    const playerId = parts[1];
                    
                    const datePart = gameId.split('-')[0];
                    if (datePart && datePart.length === 6) {
                        const year = 2000 + parseInt(datePart.substring(0, 2));
                        const month = parseInt(datePart.substring(2, 4));
                        const day = parseInt(datePart.substring(4, 6));
                        
                        return {
                            fullPaipu: paipu,
                            gameId: gameId,
                            playerId: playerId,
                            gameDate: `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                            isReplay: true,
                            uuid: gameId.split('-').slice(1).join('-')
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing paipu URL:', error.message);
                return null;
            }
        }
        
        function simulateGameMetadata(gameId) {
            const datePart = gameId.split('-')[0];
            const isRecent = datePart >= '250801';
            
            // Use hash of gameId for consistent random values
            const hash = gameId.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
            const absHash = Math.abs(hash);
            
            return {
                gameId: gameId,
                gameMode: isRecent ? 2 : 1,
                roomId: (absHash % 7) + 1,
                playersCount: 4,
                gameLength: (absHash % 120) + 60,
                isRanked: (absHash % 10) > 2,
                serverRegion: 'yo-star',
                gameType: 'standard'
            };
        }
        
        function analyzeURL() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                showResult('Please enter a URL', 'error');
                return;
            }
            
            testURL(url);
        }
        
        function testURL(url) {
            document.getElementById('urlInput').value = url;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="container"><h2>üîç Analysis Results</h2></div>';
            
            try {
                // Parse basic URL structure
                const urlContext = parseGameURL(url);
                
                let html = `
                    <div class="container">
                        <h3>üìä URL Structure Analysis</h3>
                        <div class="stats">
                            <div class="stat-box">
                                <div class="stat-value">${urlContext?.domain || 'Unknown'}</div>
                                <div>Domain</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${urlContext?.isInGame ? '‚úÖ' : '‚ùå'}</div>
                                <div>In Game</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${urlContext?.isInLobby ? '‚úÖ' : '‚ùå'}</div>
                                <div>In Lobby</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${urlContext?.roomParam || 'N/A'}</div>
                                <div>Room Param</div>
                            </div>
                        </div>
                        <div class="result">
                            <strong>Raw URL Context:</strong>
                            <pre>${JSON.stringify(urlContext, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                // Extract paipu data if it's a replay
                const paipuData = extractPaipuData(url);
                if (paipuData) {
                    html += `
                        <div class="container">
                            <h3>üé• Replay Data Analysis</h3>
                            <div class="stats">
                                <div class="stat-box">
                                    <div class="stat-value">${paipuData.gameDate}</div>
                                    <div>Game Date</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${paipuData.playerId}</div>
                                    <div>Player ID</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">‚úÖ</div>
                                    <div>Is Replay</div>
                                </div>
                            </div>
                            <div class="result success">
                                <strong>üéØ Extracted Paipu Data:</strong>
                                <pre>${JSON.stringify(paipuData, null, 2)}</pre>
                            </div>
                    `;
                    
                    // Simulate getting game metadata
                    const gameMetadata = simulateGameMetadata(paipuData.gameId);
                    html += `
                            <div class="result warning">
                                <strong>üéÆ Simulated Game Metadata:</strong>
                                <pre>${JSON.stringify(gameMetadata, null, 2)}</pre>
                            </div>
                    `;
                    
                    // Determine game context
                    const gameContext = determineGameContext({
                        game_config: {
                            meta: { mode_id: gameMetadata.roomId },
                            mode: { mode: gameMetadata.gameMode }
                        }
                    });
                    
                    html += `
                            <div class="result">
                                <strong>üèÜ Game Context Analysis:</strong>
                                <pre>${JSON.stringify(gameContext, null, 2)}</pre>
                            </div>
                    `;
                    
                    // Get strategic adjustments
                    const adjustments = getStrategicAdjustments(gameContext);
                    html += `
                            <div class="result success">
                                <strong>‚öñÔ∏è Strategic Adjustments:</strong>
                                <div class="stats">
                                    <div class="stat-box">
                                        <div class="stat-value">${adjustments.defenseMultiplier.toFixed(2)}x</div>
                                        <div>Defense</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value">${adjustments.aggressionMultiplier.toFixed(2)}x</div>
                                        <div>Aggression</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value">${adjustments.riichiThreshold.toFixed(2)}x</div>
                                        <div>Riichi Threshold</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-value">${adjustments.isHighLevel ? '‚≠ê' : 'üìö'}</div>
                                        <div>${adjustments.isHighLevel ? 'High Level' : 'Learning'}</div>
                                    </div>
                                </div>
                                <pre>${JSON.stringify(adjustments, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                    
                    // Analysis summary
                    html += `
                        <div class="container">
                            <h3>üìù Analysis Summary</h3>
                            <div class="result">
                                <p><strong>üéØ Room:</strong> <span class="highlight">${gameContext.roomName} (Tier ${gameContext.roomTier})</span></p>
                                <p><strong>üéÆ Mode:</strong> <span class="highlight">${gameContext.gameModeName}</span></p>
                                <p><strong>üìä Strategy:</strong> This is a <span class="highlight">${adjustments.isHighLevel ? 'high-level' : 'beginner-friendly'}</span> room</p>
                                <p><strong>üõ°Ô∏è Recommendation:</strong> Play <span class="highlight">${adjustments.defenseMultiplier > 1.1 ? 'more defensively' : adjustments.aggressionMultiplier > 1.1 ? 'more aggressively' : 'balanced strategy'}</span></p>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="container">
                            <h3>‚ÑπÔ∏è URL Type</h3>
                            <div class="result warning">
                                This URL does not contain replay data (paipu parameter).
                                ${urlContext?.isInGame ? 'This appears to be a live game URL.' : ''}
                                ${urlContext?.isInLobby ? 'This appears to be a lobby URL.' : ''}
                            </div>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = resultsDiv.innerHTML + html;
                
            } catch (error) {
                showResult(`Error analyzing URL: ${error.message}`, 'error');
            }
        }
        
        function loadSavedURL() {
            // Load the saved URL (Korean replay)
            const savedURL = 'https://mahjongsoul.game.yo-star.com/?paipu=250804-70f742aa-e642-478a-bb72-6d2453cae2fb_a922337773';
            document.getElementById('urlInput').value = savedURL;
            testURL(savedURL);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('urlInput').value = '';
        }
        
        function showResult(message, type = 'result') {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="container"><div class="result ${type}">${message}</div></div>`;
        }
        
        // Auto-load saved URL on page load
        window.onload = function() {
            loadSavedURL();
        };
    </script>
</body>
</html>